---
# Install Graphviz and MermaidJS CLI for all supported OSes

- name: Install Graphviz via levonk.common.package (cross-platform)
  levonk.common.package:
    name:
      - graphviz
    state: latest
  tags:
    - diagram
    - graphviz
    - tools
    - vibeops

    creates: C:\Program Files\Graphviz\bin\dot.exe
  when: ansible_os_family == 'Windows'
  tags:
    - diagram
    - graphviz
    - tools
    - windows

- name: Install MermaidJS CLI (npm, all OS)
  npm:
    name: @mermaid-js/mermaid-cli
    global: yes
    state: latest
  tags:
    - diagram
    - mermaid
    - tools
    - all_os

# Include Archi diagram tool installation
- name: Include Archi diagram tool installation
  include_tasks: archi-diagrams.yml
  tags:
    - diagram
    - tools
    - all_os
    - vibeops
    - archi
    - archimate
    - graphical


- name: Ensure mmdc is in PATH (Linux/macOS)
  file:
    src: /usr/local/lib/node_modules/@mermaid-js/mermaid-cli/bin/mmdc
    dest: /usr/local/bin/mmdc
    state: link
    force: yes
  when: ansible_os_family != 'Windows'
  tags:
    - diagram
    - mermaid
    - tools
    - all_os

- name: Ensure mmdc is in PATH (Windows)
  win_shell: |
    $npmPath = (npm root -g)
    $mmdcPath = Join-Path $npmPath '@mermaid-js/mermaid-cli\bin\mmdc.cmd'
    $target = "$env:ProgramFiles\nodejs\mmdc.cmd"
    if (!(Test-Path $target)) { Copy-Item $mmdcPath $target }
  when: ansible_os_family == 'Windows'
  tags:
    - diagram
    - mermaid
    - tools
    - windows
