---
# Configure standard system firewall for each OS

- name: Ensure UFW is installed and enabled (Debian/Ubuntu)
  ansible.builtin.apt:
    name: ufw
    state: present
  when: ansible_os_family == 'Debian'

- name: Enable UFW
  ansible.builtin.ufw:
    state: enabled
    policy: deny
  when: ansible_os_family == 'Debian'

- name: Ensure firewalld is installed and enabled (RedHat/Fedora/CentOS)
  ansible.builtin.yum:
    name: firewalld
    state: present
  when: ansible_os_family == 'RedHat'

- name: Enable firewalld
  ansible.builtin.service:
    name: firewalld
    state: started
    enabled: true
  when: ansible_os_family == 'RedHat'

# macOS: Ensure pf firewall is enabled and auto-starts at boot
- name: Ensure /etc/pf.conf exists (macOS)
  ansible.builtin.copy:
    dest: /etc/pf.conf
    content: |
      # Default pf.conf - user should customize rules as needed
      scrub-anchor "com.apple/*"
      nat-anchor "com.apple/*"
      rdr-anchor "com.apple/*"
      dummynet-anchor "com.apple/*"
      anchor "com.apple/*"
      load anchor "com.apple" from "/etc/pf.anchors/com.apple"
      pass all
    owner: root
    group: wheel
    mode: '0644'
  when: ansible_os_family == 'Darwin'

- name: Enable pf now (macOS)
  ansible.builtin.command: pfctl -e
  when: ansible_os_family == 'Darwin'
  changed_when: false
  ignore_errors: true

- name: Ensure pfctl is loaded at boot (macOS)
  ansible.builtin.command: launchctl load -w /System/Library/LaunchDaemons/com.apple.pfctl.plist
  when: ansible_os_family == 'Darwin'
  changed_when: false
  ignore_errors: true

- name: Ensure Windows Defender Firewall is enabled (Windows)
  ansible.windows.win_firewall:
    state: enabled
  when: ansible_os_family == 'Windows'
